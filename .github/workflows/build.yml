name: Build and Release

on:
  push:
    tags:
      - 'v*'
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: write
  packages: write

env:
  GO_VERSION: '1.21'

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}
        cache: false
    
    - name: Install PC/SC dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libpcsclite-dev pcscd pcsc-tools
    
    - name: Run tests
      run: go test -v ./internal/... ./cmd/...
    
    - name: Build test (current platform)
      run: |
        CGO_ENABLED=1 go build -v ./cmd/cfs-spool
        CGO_ENABLED=1 go build -v ./cmd/web-server
        CGO_ENABLED=1 go build -v ./cmd/app

  build:
    needs: test
    runs-on: ${{ matrix.os }}
    if: startsWith(github.ref, 'refs/tags/v')
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            goos: linux
            goarch: amd64
            name: linux-amd64
            display_name: "Linux"
            deps: sudo apt-get update && sudo apt-get install -y libpcsclite-dev pcscd pcsc-tools
          - os: macos-13
            goos: darwin
            goarch: amd64
            name: macos-intel
            display_name: "macOS Intel"
            deps: brew install pcsc-lite
          - os: macos-14
            goos: darwin
            goarch: arm64
            name: macos-apple-silicon
            display_name: "macOS Apple Silicon"
            deps: brew install pcsc-lite
          - os: windows-latest
            goos: windows
            goarch: amd64
            name: windows-amd64
            display_name: "Windows"
            deps: echo "Windows PC/SC drivers will be needed"
            ext: .exe
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}
        cache: false
    
    - name: Install dependencies
      run: ${{ matrix.deps }}
      shell: bash
    
    - name: Install zip (Unix)
      if: matrix.goos != 'windows'
      run: |
        if [[ "${{ matrix.goos }}" == "linux" ]]; then
          sudo apt-get install -y zip
        elif [[ "${{ matrix.goos }}" == "darwin" ]]; then
          # zip j√° est√° dispon√≠vel no macOS
          echo "zip already available on macOS"
        fi
      shell: bash
    
    - name: Build binaries
      env:
        GOOS: ${{ matrix.goos }}
        GOARCH: ${{ matrix.goarch }}
        CGO_ENABLED: 1
      run: |
        go build -ldflags "-s -w -X main.version=${{ github.ref_name }}" \
          -o cfs-spool-app-${{ matrix.name }}${{ matrix.ext }} ./cmd/app
        go build -ldflags "-s -w -X main.version=${{ github.ref_name }}" \
          -o cfs-spool-cli-${{ matrix.name }}${{ matrix.ext }} ./cmd/cfs-spool
        go build -ldflags "-s -w -X main.version=${{ github.ref_name }}" \
          -o cfs-spool-web-${{ matrix.name }}${{ matrix.ext }} ./cmd/web-server
      shell: bash
    
    - name: Create package
      run: |
        mkdir -p release/cfs-spool-${{ matrix.name }}
        cp cfs-spool-*-${{ matrix.name }}${{ matrix.ext }} release/cfs-spool-${{ matrix.name }}/
        cp -r web release/cfs-spool-${{ matrix.name }}/
        cp README.md release/cfs-spool-${{ matrix.name }}/
        
        # Create platform-specific install script
        if [[ "${{ matrix.goos }}" == "linux" ]]; then
          cat > release/cfs-spool-${{ matrix.name }}/install.sh << 'EOF'
        #!/bin/bash
        echo "Installing CFS Spool for Linux..."
        echo "1. Install PC/SC: sudo apt-get install pcscd pcsc-tools libpcsclite1"
        echo "2. Connect your RFID reader"
        echo "3. Run: ./cfs-spool-app-${{ matrix.name }}"
        echo "4. Browser will open automatically at: http://localhost:8080"
        echo "CLI usage: ./cfs-spool-cli-${{ matrix.name }} read-tag"
        EOF
          chmod +x release/cfs-spool-${{ matrix.name }}/install.sh
        elif [[ "${{ matrix.goos }}" == "darwin" ]]; then
          cat > release/cfs-spool-${{ matrix.name }}/install.sh << 'EOF'
        #!/bin/bash
        echo "Installing CFS Spool for macOS..."
        echo "1. Install PC/SC: brew install pcsc-lite (optional, usually included)"
        echo "2. Connect your RFID reader"
        echo "3. Run: ./cfs-spool-app-${{ matrix.name }}"
        echo "4. Browser will open automatically at: http://localhost:8080"
        echo "CLI usage: ./cfs-spool-cli-${{ matrix.name }} read-tag"
        EOF
          chmod +x release/cfs-spool-${{ matrix.name }}/install.sh
        elif [[ "${{ matrix.goos }}" == "windows" ]]; then
          cat > release/cfs-spool-${{ matrix.name }}/install.bat << 'EOF'
        @echo off
        echo Installing CFS Spool for Windows...
        echo 1. Install PC/SC drivers for your RFID reader
        echo 2. Connect your RFID reader
        echo 3. Run: cfs-spool-app-${{ matrix.name }}.exe
        echo 4. Browser will open automatically at: http://localhost:8080
        echo CLI usage: cfs-spool-cli-${{ matrix.name }}.exe read-tag
        EOF
        fi
        
        chmod +x release/cfs-spool-${{ matrix.name }}/cfs-spool-* 2>/dev/null || true
      shell: bash
    
    - name: Create archive (Unix)
      if: matrix.goos != 'windows'
      run: |
        cd release
        zip -r ../cfs-spool-${{ matrix.name }}.zip cfs-spool-${{ matrix.name }}/
      shell: bash
    
    - name: Create archive (Windows)
      if: matrix.goos == 'windows'
      run: |
        Compress-Archive -Path "release/cfs-spool-${{ matrix.name }}" -DestinationPath "cfs-spool-${{ matrix.name }}.zip"
      shell: powershell
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: cfs-spool-${{ matrix.name }}
        path: cfs-spool-${{ matrix.name }}.zip

  build-native-installers:
    needs: build
    runs-on: ${{ matrix.os }}
    if: startsWith(github.ref, 'refs/tags/v')
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-latest
            platform: macos
            installer_type: dmg
            artifact_pattern: "cfs-spool-macos*"
          - os: ubuntu-latest
            platform: linux
            installer_type: appimage
            artifact_pattern: "cfs-spool-linux*"
          - os: windows-latest
            platform: windows
            installer_type: exe
            artifact_pattern: "cfs-spool-windows*"
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Download platform artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
    
    - name: Prepare installer workspace
      run: |
        mkdir -p installer-workspace
        echo "Looking for ZIP files..."
        find artifacts -name "*.zip" -type f || echo "No ZIP files found"
        ls -la artifacts/ || echo "No artifacts directory"
        
        # Extract first ZIP found
        if [ -f "$(find artifacts -name "*.zip" | head -1)" ]; then
          echo "Extracting ZIP file..."
          find artifacts -name "*.zip" | head -1 | xargs -I {} unzip {} -d installer-workspace/
          echo "Contents after extraction:"
          ls -la installer-workspace/
        else
          echo "ERROR: No ZIP files found in artifacts"
          exit 1
        fi
      shell: bash
    
    # macOS DMG Creation
    - name: Create macOS DMG
      if: matrix.platform == 'macos'
      run: |
        # Install create-dmg
        brew install create-dmg
        
        # Create app bundle structure
        mkdir -p "CFS Spool.app/Contents/MacOS"
        mkdir -p "CFS Spool.app/Contents/Resources"
        
        # Copy binaries
        find installer-workspace -name "cfs-spool-app-*" ! -name "*.zip" | head -1 | xargs -I {} cp {} "CFS Spool.app/Contents/MacOS/cfs-spool"
        find installer-workspace -name "cfs-spool-cli-*" ! -name "*.zip" | head -1 | xargs -I {} cp {} "CFS Spool.app/Contents/MacOS/cfs-spool-cli"
        
        # Copy web assets
        cp -r installer-workspace/*/web "CFS Spool.app/Contents/Resources/"
        
        # Create Info.plist
        cat > "CFS Spool.app/Contents/Info.plist" << 'EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>CFBundleExecutable</key>
            <string>cfs-spool</string>
            <key>CFBundleIdentifier</key>
            <string>com.creality.cfs-spool</string>
            <key>CFBundleName</key>
            <string>CFS Spool</string>
            <key>CFBundleVersion</key>
            <string>${{ github.ref_name }}</string>
            <key>CFBundleShortVersionString</key>
            <string>${{ github.ref_name }}</string>
            <key>CFBundlePackageType</key>
            <string>APPL</string>
            <key>LSUIElement</key>
            <true/>
            <key>NSHighResolutionCapable</key>
            <true/>
        </dict>
        </plist>
        EOF
        
        # Make executable
        chmod +x "CFS Spool.app/Contents/MacOS/cfs-spool"
        chmod +x "CFS Spool.app/Contents/MacOS/cfs-spool-cli"
        
        # Create DMG
        create-dmg \
          --volname "CFS Spool ${{ github.ref_name }}" \
          --window-pos 200 120 \
          --window-size 600 400 \
          --icon-size 100 \
          --icon "CFS Spool.app" 175 190 \
          --hide-extension "CFS Spool.app" \
          --app-drop-link 425 190 \
          "cfs-spool-${{ github.ref_name }}.dmg" \
          "CFS Spool.app"
    
    # Linux AppImage Creation
    - name: Create Linux AppImage
      if: matrix.platform == 'linux'
      run: |
        # Install dependencies
        sudo apt-get update
        sudo apt-get install -y wget file libpcsclite1 libpcsclite-dev
        
        # Download linuxdeploy and AppImageTool
        wget https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
        chmod +x linuxdeploy-x86_64.AppImage
        
        # Create AppDir structure
        mkdir -p AppDir/usr/bin
        mkdir -p AppDir/usr/lib
        mkdir -p AppDir/usr/share/applications
        mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps
        mkdir -p AppDir/usr/share/cfs-spool
        
        # Copy binaries
        find installer-workspace -name "cfs-spool-app-*" ! -name "*.zip" | head -1 | xargs -I {} cp {} AppDir/usr/bin/cfs-spool
        find installer-workspace -name "cfs-spool-cli-*" ! -name "*.zip" | head -1 | xargs -I {} cp {} AppDir/usr/bin/cfs-spool-cli
        
        # Copy web assets
        cp -r installer-workspace/*/web AppDir/usr/share/cfs-spool/
        
        # Copy PC/SC libraries
        cp /usr/lib/x86_64-linux-gnu/libpcsclite.so.1 AppDir/usr/lib/ || true
        cp /lib/x86_64-linux-gnu/libpcsclite.so.1 AppDir/usr/lib/ || true
        
        # Create desktop file
        cat > AppDir/usr/share/applications/cfs-spool.desktop << 'EOF'
        [Desktop Entry]
        Type=Application
        Name=CFS Spool
        Comment=Creality CFS RFID Tag Reader
        Exec=cfs-spool
        Icon=cfs-spool
        Categories=Utility;
        Terminal=false
        EOF
        
        # Create simple icon (text-based)
        cat > AppDir/usr/share/icons/hicolor/256x256/apps/cfs-spool.svg << 'EOF'
        <svg width="256" height="256" xmlns="http://www.w3.org/2000/svg">
          <rect width="256" height="256" fill="#1976d2"/>
          <text x="128" y="140" font-family="Arial" font-size="48" fill="white" text-anchor="middle">CFS</text>
        </svg>
        EOF
        
        # Make executable
        chmod +x AppDir/usr/bin/cfs-spool
        chmod +x AppDir/usr/bin/cfs-spool-cli
        
        # Create AppImage with bundled libraries
        export LD_LIBRARY_PATH="$PWD/AppDir/usr/lib:$LD_LIBRARY_PATH"
        ./linuxdeploy-x86_64.AppImage --appdir AppDir --output appimage --library AppDir/usr/lib/libpcsclite.so.1 || true
        
        # Fallback: try without library bundling
        if [ ! -f *.AppImage ]; then
          echo "Trying without library bundling..."
          ./linuxdeploy-x86_64.AppImage --appdir AppDir --output appimage
        fi
        
        # Rename to proper name
        mv CFS_Spool*.AppImage "cfs-spool-${{ github.ref_name }}.AppImage" || mv *.AppImage "cfs-spool-${{ github.ref_name }}.AppImage"
    
    # Windows Installer Creation
    - name: Create Windows Installer
      if: matrix.platform == 'windows'
      run: |
        # Install NSIS
        choco install nsis -y
        
        # Create installer directory structure
        mkdir -p installer/bin
        mkdir -p installer/web
        
        # Copy files
        Get-ChildItem installer-workspace -Recurse -Name "cfs-spool-app-*.exe" | ForEach-Object { Copy-Item "installer-workspace/$_" "installer/bin/cfs-spool.exe" }
        Get-ChildItem installer-workspace -Recurse -Name "cfs-spool-cli-*.exe" | ForEach-Object { Copy-Item "installer-workspace/$_" "installer/bin/cfs-spool-cli.exe" }
        Copy-Item -Recurse installer-workspace/*/web/* installer/web/
        
        # Create NSIS script
        @"
        !define APPNAME "CFS Spool"
        !define COMPANYNAME "Creality"
        !define DESCRIPTION "Creality CFS RFID Tag Reader"
        !define VERSIONMAJOR 1
        !define VERSIONMINOR 0
        !define VERSIONBUILD 0
        !define HELPURL "https://github.com/robertocorreajr/cfs_spool"
        !define UPDATEURL "https://github.com/robertocorreajr/cfs_spool/releases"
        !define ABOUTURL "https://github.com/robertocorreajr/cfs_spool"
        !define INSTALLSIZE 50000
        
        RequestExecutionLevel admin
        InstallDir "$PROGRAMFILES\${APPNAME}"
        Name "${APPNAME}"
        outFile "cfs-spool-${{ github.ref_name }}-installer.exe"
        
        !include LogicLib.nsh
        
        page components
        page directory
        page instfiles
        
        !macro VerifyUserIsAdmin
        UserInfo::GetAccountType
        Pop $0
        ${If} $0 != "admin"
            messageBox MB_ICONSTOP "Administrator rights required!"
            setErrorLevel 740
            quit
        ${EndIf}
        !macroend
        
        function .onInit
            setShellVarContext all
            !insertmacro VerifyUserIsAdmin
        functionEnd
        
        section "install"
            setOutPath $INSTDIR
            file /r "installer\*"
            
            writeUninstaller "$INSTDIR\uninstall.exe"
            
            createDirectory "$SMPROGRAMS\${APPNAME}"
            createShortCut "$SMPROGRAMS\${APPNAME}\${APPNAME}.lnk" "$INSTDIR\bin\cfs-spool.exe"
            createShortCut "$DESKTOP\${APPNAME}.lnk" "$INSTDIR\bin\cfs-spool.exe"
            
            writeRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\${APPNAME}" "DisplayName" "${APPNAME}"
            writeRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\${APPNAME}" "UninstallString" "$\"$INSTDIR\uninstall.exe$\""
            writeRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\${APPNAME}" "QuietUninstallString" "$\"$INSTDIR\uninstall.exe$\" /S"
            writeRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\${APPNAME}" "InstallLocation" "$\"$INSTDIR$\""
            writeRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\${APPNAME}" "Publisher" "${COMPANYNAME}"
            writeRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\${APPNAME}" "HelpLink" "${HELPURL}"
            writeRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\${APPNAME}" "URLUpdateInfo" "${UPDATEURL}"
            writeRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\${APPNAME}" "URLInfoAbout" "${ABOUTURL}"
            writeRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\${APPNAME}" "DisplayVersion" "${VERSIONMAJOR}.${VERSIONMINOR}.${VERSIONBUILD}"
            writeRegDWORD HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\${APPNAME}" "VersionMajor" ${VERSIONMAJOR}
            writeRegDWORD HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\${APPNAME}" "VersionMinor" ${VERSIONMINOR}
            writeRegDWORD HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\${APPNAME}" "NoModify" 1
            writeRegDWORD HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\${APPNAME}" "NoRepair" 1
            writeRegDWORD HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\${APPNAME}" "EstimatedSize" ${INSTALLSIZE}
        sectionEnd
        
        section "uninstall"
            delete "$SMPROGRAMS\${APPNAME}\${APPNAME}.lnk"
            delete "$DESKTOP\${APPNAME}.lnk"
            rmDir "$SMPROGRAMS\${APPNAME}"
            
            delete $INSTDIR\uninstall.exe
            rmDir /r $INSTDIR
            
            deleteRegKey HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\${APPNAME}"
        sectionEnd
        "@ | Out-File -FilePath installer.nsi -Encoding ASCII
        
        # Build installer
        & "C:\Program Files (x86)\NSIS\makensis.exe" installer.nsi
      shell: powershell
    
    - name: Upload native installer
      uses: actions/upload-artifact@v4
      with:
        name: native-installer-${{ matrix.platform }}
        path: |
          *.dmg
          *.AppImage
          *-installer.exe

  release:
    needs: [build, build-native-installers]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
    
    - name: Organize release files
      run: |
        mkdir -p release-files
        
        # ZIP packages
        find artifacts -name "*.zip" | while read file; do
          cp "$file" release-files/
        done
        
        # Native installers
        find artifacts -name "*.dmg" -o -name "*.AppImage" -o -name "*-installer.exe" | while read file; do
          cp "$file" release-files/
        done
        
        ls -la release-files/
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        draft: false
        prerelease: false
        generate_release_notes: true
        body: |
          ## üéâ CFS Spool ${{ github.ref_name }}
          
          ### üì¶ Instaladores Nativos (Recomendado para usu√°rios finais)
          
          #### üçé macOS
          - **macOS Universal**: `cfs-spool-${{ github.ref_name }}.dmg` 
            - Arraste para Applications
            - Execute "CFS Spool"
            - Acesse: http://localhost:8080
          
          #### üêß Linux  
          - **Linux Portable**: `cfs-spool-${{ github.ref_name }}.AppImage`
            - `chmod +x cfs-spool-*.AppImage`
            - `./cfs-spool-*.AppImage`
            - Acesse: http://localhost:8080
          
          #### ü™ü Windows
          - **Windows Installer**: `cfs-spool-${{ github.ref_name }}-installer.exe`
            - Execute como Administrador
            - Siga o assistente de instala√ß√£o
            - Atalho criado na √Årea de Trabalho
            - Acesse: http://localhost:8080
          
          ### üì¶ Pacotes ZIP (Para desenvolvedores)
          
          #### üêß Linux
          - **Linux 64-bit**: `cfs-spool-linux-amd64.zip`
          
          #### üçé macOS
          - **macOS Intel**: `cfs-spool-macos-intel.zip`
          - **macOS Apple Silicon**: `cfs-spool-macos-apple-silicon.zip`
          
          #### ü™ü Windows
          - **Windows 64-bit**: `cfs-spool-windows-amd64.zip`
          
          ### üöÄ Quick Start (Instaladores Nativos)
          
          #### üçé macOS:
          1. Download: `cfs-spool-${{ github.ref_name }}.dmg`
          2. Abra o DMG e arraste "CFS Spool" para Applications
          3. Conecte seu leitor RFID ACR122U
          4. Execute "CFS Spool" pelo Launchpad
          5. Acesse: http://localhost:8080
          
          #### üêß Linux:
          1. Download: `cfs-spool-${{ github.ref_name }}.AppImage`
          2. `chmod +x cfs-spool-*.AppImage`
          3. Conecte seu leitor RFID ACR122U
          4. Execute: `./cfs-spool-*.AppImage`
          5. Acesse: http://localhost:8080
          
          #### ü™ü Windows:
          1. Download: `cfs-spool-${{ github.ref_name }}-installer.exe`
          2. Execute como Administrador
          3. Siga o assistente de instala√ß√£o
          4. Conecte seu leitor RFID ACR122U
          5. Execute "CFS Spool" pelo atalho da √Årea de Trabalho
          6. Acesse: http://localhost:8080
          
          ### ‚öôÔ∏è Pr√©-requisitos
          
          - **RFID Reader**: ACR122U ou compat√≠vel
          - **Windows**: Drivers PC/SC autom√°ticos
          - **macOS**: PC/SC inclu√≠do no sistema
          - **Linux**: `sudo apt install pcscd pcsc-tools`
          
          ### üÜò Support
          
          - Issues: https://github.com/robertocorreajr/cfs_spool/issues
          - Documentation: https://github.com/robertocorreajr/cfs_spool#readme
        files: |
          release-files/*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
